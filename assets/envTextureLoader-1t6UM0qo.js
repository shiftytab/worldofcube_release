const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/rgbdDecode.fragment-BwvPgIDt.js","assets/index-DQWvKL4l.js","assets/index-XcJlsfGO.css","assets/helperFunctions-BUzvRiIs.js","assets/rgbdDecode.fragment-Dxor9zkm.js","assets/helperFunctions-CKmiry23.js"])))=>i.map(i=>d[i]);
import{B as P,b as O,T as D,d as B,e as C,I as U,V as m}from"./index-DQWvKL4l.js";import{C as z,P as G,S as V}from"./passPostProcess-D95XhaxV.js";import"./dumpTools-mxzyolNU.js";P.prototype.forceSphericalPolynomialsRecompute=function(){this._texture&&(this._texture._sphericalPolynomial=null,this._texture._sphericalPolynomialPromise=null,this._texture._sphericalPolynomialComputed=!1)};Object.defineProperty(P.prototype,"sphericalPolynomial",{get:function(){if(this._texture){if(this._texture._sphericalPolynomial||this._texture._sphericalPolynomialComputed)return this._texture._sphericalPolynomial;if(this._texture.isReady)return this._texture._sphericalPolynomialPromise||(this._texture._sphericalPolynomialPromise=z.ConvertCubeMapTextureToSphericalPolynomial(this),this._texture._sphericalPolynomialPromise===null?this._texture._sphericalPolynomialComputed=!0:this._texture._sphericalPolynomialPromise.then(e=>{this._texture._sphericalPolynomial=e,this._texture._sphericalPolynomialComputed=!0})),null}return null},set:function(e){this._texture&&(this._texture._sphericalPolynomial=e)},enumerable:!0,configurable:!0});const S="image/png",I=2,M=[134,22,135,150,246,214,150,54];function k(e){const a=new DataView(e.buffer,e.byteOffset,e.byteLength);let t=0;for(let l=0;l<M.length;l++)if(a.getUint8(t++)!==M[l])return O.Error("Not a babylon environment map"),null;let r="",o=0;for(;o=a.getUint8(t++);)r+=String.fromCharCode(o);let n=JSON.parse(r);return n=A(n),n.specular&&(n.specular.specularDataPosition=t,n.specular.lodGenerationScale=n.specular.lodGenerationScale||.8),n}function A(e){if(e.version>I)throw new Error(`Unsupported babylon environment map version "${e.version}". Latest supported version is "${I}".`);return e.version===2||(e={...e,version:2,imageType:S}),e}function E(e,a){a=A(a);const t=a.specular;let r=Math.log2(a.width);if(r=Math.round(r)+1,t.mipmaps.length!==6*r)throw new Error(`Unsupported specular mipmaps number "${t.mipmaps.length}"`);const o=new Array(r);for(let n=0;n<r;n++){o[n]=new Array(6);for(let l=0;l<6;l++){const s=t.mipmaps[n*6+l];o[n][l]=new Uint8Array(e.buffer,e.byteOffset+t.specularDataPosition+s.position,s.length)}}return o}function H(e,a,t){t=A(t);const r=t.specular;if(!r)return Promise.resolve();e._lodGenerationScale=r.lodGenerationScale;const o=E(a,t);return N(e,o,t.imageType)}function F(e,a,t,r,o,n,l,s,h,_,y){return new Promise((x,v)=>{if(t){const i=a.createTexture(null,!0,!0,null,1,null,u=>{v(u)},e);r==null||r.onEffectCreatedObservable.addOnce(u=>{u.executeWhenCompiled(()=>{r.externalTextureSamplerBinding=!0,r.onApply=p=>{p._bindTexture("textureSampler",i),p.setFloat2("scale",1,a._features.needsInvertingBitmap&&e instanceof ImageBitmap?-1:1)},a.scenes.length&&(a.scenes[0].postProcessManager.directRender([r],_,!0,n,l),a.restoreDefaultFramebuffer(),i.dispose(),URL.revokeObjectURL(o),x())})})}else{if(a._uploadImageToTexture(y,e,n,l),s){const i=h[l];i&&a._uploadImageToTexture(i._texture,e,n,0)}x()}})}async function N(e,a,t=S){if(!D.IsExponentOfTwo(e.width))throw new Error("Texture size must be a power of two");const r=B(e.width)+1,o=e.getEngine();let n=!1,l=!1,s=null,h=null,_=null;const y=o.getCaps();e.format=5,e.type=0,e.generateMipMaps=!0,e._cachedAnisotropicFilteringLevel=null,o.updateTextureSamplingMode(3,e),y.textureLOD?o._features.supportRenderAndCopyToLodForFloatTextures?y.textureHalfFloatRender&&y.textureHalfFloatLinearFiltering?(n=!0,e.type=2):y.textureFloatRender&&y.textureFloatLinearFiltering&&(n=!0,e.type=1):n=!1:(n=!1,l=!0,_={});let x=0;if(n)o.isWebGPU?(x=1,await C(()=>import("./rgbdDecode.fragment-BwvPgIDt.js"),__vite__mapDeps([0,1,2,3]))):await C(()=>import("./rgbdDecode.fragment-Dxor9zkm.js"),__vite__mapDeps([4,1,2,5])),s=new G("rgbdDecode","rgbdDecode",null,null,1,null,3,o,!1,void 0,e.type,void 0,null,!1,void 0,x),e._isRGBD=!1,e.invertY=!1,h=o.createRenderTargetCubeTexture(e.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:e.type,format:5});else if(e._isRGBD=!0,e.invertY=!0,l){const u=e._lodGenerationScale,p=e._lodGenerationOffset;for(let c=0;c<3;c++){const g=1-c/2,f=p,L=(r-1)*u+p,R=f+(L-f)*g,w=Math.round(Math.min(Math.max(R,0),L)),b=new U(o,2);b.isCube=!0,b.invertY=!0,b.generateMipMaps=!1,o.updateTextureSamplingMode(2,b);const T=new P(null);switch(T._isCube=!0,T._texture=b,_[w]=T,c){case 0:e._lodTextureLow=T;break;case 1:e._lodTextureMid=T;break;case 2:e._lodTextureHigh=T;break}}}const v=[];for(let i=0;i<a.length;i++)for(let u=0;u<6;u++){const p=a[i][u],c=new Blob([p],{type:t}),d=URL.createObjectURL(c);let g;if(o._features.forceBitmapOverHTMLImageElement)g=o.createImageBitmap(c,{premultiplyAlpha:"none"}).then(f=>F(f,o,n,s,d,u,i,l,_,h,e));else{const f=new Image;f.src=d,g=new Promise((L,R)=>{f.onload=()=>{F(f,o,n,s,d,u,i,l,_,h,e).then(()=>L()).catch(w=>{R(w)})},f.onerror=w=>{R(w)}})}v.push(g)}if(a.length<r){let i;const u=Math.pow(2,r-1-a.length),p=u*u*4;switch(e.type){case 0:{i=new Uint8Array(p);break}case 2:{i=new Uint16Array(p);break}case 1:{i=new Float32Array(p);break}}for(let c=a.length;c<r;c++)for(let d=0;d<6;d++)o._uploadArrayBufferViewToTexture(e,i,d,c)}return Promise.all(v).then(()=>{h&&(o._releaseTexture(e),h._swapAndDie(e)),s&&s.dispose(),l&&(e._lodTextureHigh&&e._lodTextureHigh._texture&&(e._lodTextureHigh._texture.isReady=!0),e._lodTextureMid&&e._lodTextureMid._texture&&(e._lodTextureMid._texture.isReady=!0),e._lodTextureLow&&e._lodTextureLow._texture&&(e._lodTextureLow._texture.isReady=!0))})}function Y(e,a){a=A(a);const t=a.irradiance;if(!t)return;const r=new V;m.FromArrayToRef(t.x,0,r.x),m.FromArrayToRef(t.y,0,r.y),m.FromArrayToRef(t.z,0,r.z),m.FromArrayToRef(t.xx,0,r.xx),m.FromArrayToRef(t.yy,0,r.yy),m.FromArrayToRef(t.zz,0,r.zz),m.FromArrayToRef(t.yz,0,r.yz),m.FromArrayToRef(t.zx,0,r.zx),m.FromArrayToRef(t.xy,0,r.xy),e._sphericalPolynomial=r}class J{constructor(){this.supportCascades=!1}loadCubeData(a,t,r,o,n){if(Array.isArray(a))return;const l=k(a);if(l){t.width=l.width,t.height=l.width;try{Y(t,l),H(t,a,l).then(()=>{t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),o&&o()},s=>{n==null||n("Can not upload environment levels",s)})}catch(s){n==null||n("Can not upload environment file",s)}}else n&&n("Can not parse the environment file",null)}loadData(){throw".env not supported in 2d."}}export{J as _ENVTextureLoader};
